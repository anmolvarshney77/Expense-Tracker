# Render Blueprint: backend (Django + Gunicorn) + PostgreSQL (free tier)
# Deploy: push to GitHub, connect repo at https://dashboard.render.com → New → Blueprint
# Then set CORS_ALLOWED_ORIGINS in the web service to your frontend URL (e.g. https://your-app.vercel.app)

databases:
  - name: expense-tracker-db
    databaseName: expenses_db
    plan: free

services:
  - type: web
    name: expense-tracker-backend
    runtime: python
    plan: free
    rootDir: backend
    buildCommand: "pip install -r requirements.txt && python manage.py collectstatic --noinput"
    # Retry migrate until DB host resolves (Render internal DNS can lag at startup)
    startCommand: "for i in 1 2 3 4 5 6 7 8 9 10; do python manage.py migrate --noinput && break; echo 'Waiting for database...'; sleep 5; done && exec python -m gunicorn config.wsgi:application --bind 0.0.0.0:$PORT"
    envVars:
      - key: DATABASE_URL
        fromDatabase:
          name: expense-tracker-db
          property: connectionString
      - key: SECRET_KEY
        generateValue: true
      - key: DEBUG
        value: "False"
      - key: ALLOWED_HOSTS
        value: ".onrender.com"
      - key: CORS_ALLOWED_ORIGINS
        sync: false
